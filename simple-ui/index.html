<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Down-Nexus 简易管理界面</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
        }
        .status-badge {
            font-size: 0.8em;
        }
        .progress {
            height: 0.5rem;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
        }
        .table th {
            font-weight: 600;
            font-size: 0.9rem;
        }
        .torrent-name {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .action-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        .api-endpoint {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-cloud-download me-2"></i>Down-Nexus
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text" id="server-status">
                    <i class="bi bi-circle-fill text-success me-1"></i>服务运行中
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <!-- 左侧 - 系统信息和客户端 -->
            <div class="col-md-4">
                <!-- 系统状态卡片 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">系统状态</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshSystemStatus()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>服务状态</span>
                                <span id="health-status" class="text-success">正常</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>客户端数量</span>
                                <span id="client-count">-</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>种子总数</span>
                                <span id="torrent-count">-</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>API版本</span>
                                <span>v1.0.0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 客户端配置卡片 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">客户端配置</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshClients()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="client-list">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧 - 种子管理 -->
            <div class="col-md-8">
                <!-- 标签页 -->
                <ul class="nav nav-tabs" id="torrentTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">全部种子</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="downloading-tab" data-bs-toggle="tab" data-bs-target="#downloading" type="button" role="tab">下载中</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="seeding-tab" data-bs-toggle="tab" data-bs-target="#seeding" type="button" role="tab">做种中</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="paused-tab" data-bs-toggle="tab" data-bs-target="#paused" type="button" role="tab">已暂停</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">添加种子</button>
                    </li>
                </ul>

                <!-- 标签内容 -->
                <div class="tab-content pt-3" id="torrentTabContent">
                    <!-- 全部种子标签 -->
                    <div class="tab-pane fade show active" id="all" role="tabpanel">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">种子列表</h5>
                                <div>
                                    <select id="client-filter" class="form-select form-select-sm me-2" style="width: auto; display: inline-block;">
                                        <option value="">所有客户端</option>
                                    </select>
                                    <button class="btn btn-sm btn-primary" onclick="refreshTorrents()">
                                        <i class="bi bi-arrow-clockwise"></i> 刷新
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm">
                                        <thead>
                                            <tr>
                                                <th>名称</th>
                                                <th>客户端</th>
                                                <th>大小</th>
                                                <th>进度</th>
                                                <th>状态</th>
                                                <th>下载速度</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="all-torrents-list">
                                            <tr>
                                                <td colspan="7" class="text-center py-4">
                                                    <div class="spinner-border spinner-border-sm" role="status">
                                                        <span class="visually-hidden">加载中...</span>
                                                    </div>
                                                    正在加载种子列表...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="p-2 text-center">
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadMoreTorrents()">
                                        加载更多
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 下载中标签 -->
                    <div class="tab-pane fade" id="downloading" role="tabpanel">
                        <div class="card">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm">
                                        <thead>
                                            <tr>
                                                <th>名称</th>
                                                <th>客户端</th>
                                                <th>进度</th>
                                                <th>下载速度</th>
                                                <th>剩余时间</th>
                                            </tr>
                                        </thead>
                                        <tbody id="downloading-torrents-list">
                                            <tr>
                                                <td colspan="5" class="text-center py-4">
                                                    <div class="spinner-border spinner-border-sm" role="status">
                                                        <span class="visually-hidden">加载中...</span>
                                                    </div>
                                                    正在加载下载中的种子...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 做种中标签 -->
                    <div class="tab-pane fade" id="seeding" role="tabpanel">
                        <div class="card">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm">
                                        <thead>
                                            <tr>
                                                <th>名称</th>
                                                <th>客户端</th>
                                                <th>大小</th>
                                                <th>上传速度</th>
                                                <th>已上传</th>
                                            </tr>
                                        </thead>
                                        <tbody id="seeding-torrents-list">
                                            <tr>
                                                <td colspan="5" class="text-center py-4">
                                                    <div class="spinner-border spinner-border-sm" role="status">
                                                        <span class="visually-hidden">加载中...</span>
                                                    </div>
                                                    正在加载做种中的种子...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 已暂停标签 -->
                    <div class="tab-pane fade" id="paused" role="tabpanel">
                        <div class="card">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm">
                                        <thead>
                                            <tr>
                                                <th>名称</th>
                                                <th>客户端</th>
                                                <th>大小</th>
                                                <th>进度</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="paused-torrents-list">
                                            <tr>
                                                <td colspan="5" class="text-center py-4">
                                                    <div class="spinner-border spinner-border-sm" role="status">
                                                        <span class="visually-hidden">加载中...</span>
                                                    </div>
                                                    正在加载已暂停的种子...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 添加种子标签 -->
                    <div class="tab-pane fade" id="add" role="tabpanel">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title mb-4">添加新种子</h5>
                                
                                <form id="add-torrent-form">
                                    <div class="mb-3">
                                        <label for="client-select" class="form-label">客户端</label>
                                        <select class="form-select" id="client-select" required>
                                            <option value="">选择客户端...</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="torrent-url" class="form-label">种子URL</label>
                                        <textarea class="form-control" id="torrent-url" rows="3" placeholder="磁力链接或HTTP种子链接"></textarea>
                                        <div class="form-text">支持磁力链接(magnet:)或HTTP种子链接</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="save-path" class="form-label">保存路径（可选）</label>
                                        <input type="text" class="form-control" id="save-path" placeholder="如: /downloads">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="category" class="form-label">分类（可选）</label>
                                        <input type="text" class="form-control" id="category" placeholder="如: movies, series">
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-plus-circle me-1"></i> 添加种子
                                    </button>
                                </form>
                                
                                <div id="add-result" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- API 端点参考 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">API 端点参考</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>基础接口</h6>
                                <ul class="list-unstyled">
                                    <li><code class="api-endpoint">GET /</code> - 欢迎页面</li>
                                    <li><code class="api-endpoint">GET /health</code> - 健康检查</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>种子管理</h6>
                                <ul class="list-unstyled">
                                    <li><code class="api-endpoint">GET /api/v1/torrents</code> - 获取种子列表</li>
                                    <li><code class="api-endpoint">POST /api/v1/torrents</code> - 添加种子</li>
                                    <li><code class="api-endpoint">POST /api/v1/torrents/pause</code> - 暂停种子</li>
                                    <li><code class="api-endpoint">POST /api/v1/torrents/resume</code> - 恢复种子</li>
                                    <li><code class="api-endpoint">DELETE /api/v1/torrents</code> - 删除种子</li>
                                </ul>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>客户端管理</h6>
                                <ul class="list-unstyled">
                                    <li><code class="api-endpoint">GET /api/v1/clients</code> - 获取客户端列表</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-light py-3 mt-5">
        <div class="container text-center">
            <small class="text-muted">Down-Nexus API - 多客户端种子管理系统</small>
        </div>
    </footer>

    <!-- Toast 通知 -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-info-circle-fill text-primary me-2"></i>
                <strong class="me-auto">Down-Nexus</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message">
                操作成功完成
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API 基础URL
        const API_BASE = 'http://localhost:8080';
        
        // 全局变量
        let allTorrents = [];
        let clients = [];
        let displayedTorrents = [];
        const TORRENT_LIMIT = 20;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeUI();
        });
        
        // 初始化界面
        async function initializeUI() {
            await Promise.all([
                checkSystemStatus(),
                loadClients(),
                loadTorrents()
            ]);
        }
        
        // 检查系统状态
        async function checkSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    document.getElementById('health-status').textContent = '正常';
                    document.getElementById('health-status').className = 'text-success';
                    document.getElementById('server-status').innerHTML = '<i class="bi bi-circle-fill text-success me-1"></i>服务运行中';
                } else {
                    throw new Error('服务不可用');
                }
            } catch (error) {
                document.getElementById('health-status').textContent = '连接失败';
                document.getElementById('health-status').className = 'text-danger';
                document.getElementById('server-status').innerHTML = '<i class="bi bi-circle-fill text-danger me-1"></i>服务离线';
            }
        }
        
        // 加载客户端配置
        async function loadClients() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/clients`);
                if (response.ok) {
                    const data = await response.json();
                    clients = data.data || [];
                    
                    // 更新客户端数量
                    document.getElementById('client-count').textContent = data.count || 0;
                    
                    // 渲染客户端列表
                    renderClientList(clients);
                    
                    // 填充客户端筛选下拉框
                    populateClientFilters(clients);
                } else {
                    throw new Error('获取客户端失败');
                }
            } catch (error) {
                console.error('加载客户端失败:', error);
                document.getElementById('client-count').textContent = '获取失败';
                document.getElementById('client-list').innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle me-1"></i>加载客户端配置失败
                    </div>
                `;
            }
        }
        
        // 渲染客户端列表
        function renderClientList(clients) {
            const container = document.getElementById('client-list');
            
            if (!clients || clients.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                        暂无客户端配置
                    </div>
                `;
                return;
            }
            
            container.innerHTML = clients.map(client => {
                const clientIcon = client.type === 'qbittorrent' ? 'bi-qq' : 'bi-download';
                const statusIcon = client.enabled ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger';
                
                return `
                    <div class="mb-3 p-2 border rounded ${client.enabled ? 'border-success' : 'border-secondary bg-light'}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold">${client.name}</div>
                                <small class="text-muted">${client.type} - ${client.host}</small>
                            </div>
                            <i class="${statusIcon}"></i>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 填充客户端筛选器
        function populateClientFilters(clients) {
            const clientFilter = document.getElementById('client-filter');
            const clientSelect = document.getElementById('client-select');
            
            // 清空现有选项
            clientFilter.innerHTML = '<option value="">所有客户端</option>';
            clientSelect.innerHTML = '<option value="">选择客户端...</option>';
            
            // 添加客户端选项
            clients.forEach(client => {
                // 客户端筛选器
                const filterOption = document.createElement('option');
                filterOption.value = client.id;
                filterOption.textContent = `${client.name} (${client.type})`;
                clientFilter.appendChild(filterOption);
                
                // 客户端选择器（仅启用的客户端）
                if (client.enabled) {
                    const selectOption = document.createElement('option');
                    selectOption.value = client.id;
                    selectOption.textContent = `${client.name} (${client.type})`;
                    clientSelect.appendChild(selectOption);
                }
            });
        }
        
        // 加载种子列表
        async function loadTorrents() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/torrents`);
                if (response.ok) {
                    const data = await response.json();
                    allTorrents = data.data || [];
                    
                    // 更新种子总数
                    document.getElementById('torrent-count').textContent = data.count || 0;
                    
                    // 渲染种子列表
                    renderTorrentsByState();
                    
                    // 更新显示的种子列表
                    displayedTorrents = allTorrents.slice(0, TORRENT_LIMIT);
                    renderTorrentList(displayedTorrents, 'all-torrents-list');
                } else {
                    throw new Error('获取种子失败');
                }
            } catch (error) {
                console.error('加载种子失败:', error);
                document.getElementById('torrent-count').textContent = '获取失败';
                
                // 更新各标签的种子列表为错误状态
                ['all-torrents-list', 'downloading-torrents-list', 'seeding-torrents-list', 'paused-torrents-list'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="alert alert-danger" role="alert">
                                        <i class="bi bi-exclamation-triangle me-1"></i>加载种子列表失败
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                });
            }
        }
        
        // 根据状态渲染种子列表
        function renderTorrentsByState() {
            // 分类种子
            const downloading = allTorrents.filter(t => 
                t.state === 'downloading' || t.state === 'stalledDL' || t.state === 'allocating' || t.state === 'metaDL'
            );
            
            const seeding = allTorrents.filter(t => 
                t.state === 'uploading' || t.state === 'seeding' || t.state === 'stalledUP' || t.state === 'forcedUP'
            );
            
            const paused = allTorrents.filter(t => 
                t.state === 'pausedDL' || t.state === 'pausedUP' || t.state === 'stopped'
            );
            
            // 渲染各类种子列表
            renderTorrentList(downloading.slice(0, 10), 'downloading-torrents-list', true);
            renderTorrentList(seeding.slice(0, 10), 'seeding-torrents-list', true);
            renderTorrentList(paused.slice(0, 10), 'paused-torrents-list', true);
        }
        
        // 渲染种子列表
        function renderTorrentList(torrents, containerId, compact = false) {
            const container = document.getElementById(containerId);
            
            if (!torrents || torrents.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="${compact ? 5 : 7}" class="text-center py-4">
                            <div class="text-muted">
                                <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                                暂无种子
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            container.innerHTML = torrents.map(torrent => {
                const clientIcon = torrent.client_id.startsWith('qb-') ? 'bi-qq text-primary' : 'bi-download text-success';
                const progressPercent = (torrent.progress * 100).toFixed(1);
                const size = formatBytes(torrent.size);
                const downloadSpeed = formatBytes(torrent.download_speed) + '/s';
                const uploadSpeed = formatBytes(torrent.upload_speed) + '/s';
                const eta = torrent.eta === 8640000 ? '∞' : torrent.eta === -1 ? '完成' : formatSeconds(torrent.eta);
                
                if (compact) {
                    // 紧凑模式 - 用于特定状态标签
                    return `
                        <tr>
                            <td class="torrent-name" title="${torrent.name}">${torrent.name}</td>
                            <td>
                                <i class="${clientIcon}"></i>
                            </td>
                            ${containerId === 'downloading-torrents-list' ? 
                                `<td>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%">${progressPercent}%</div>
                                    </div>
                                </td>
                                <td>${downloadSpeed}</td>
                                <td>${eta}</td>` :
                                containerId === 'seeding-torrents-list' ?
                                `<td>${size}</td>
                                <td>${uploadSpeed}</td>
                                <td>${formatBytes(torrent.uploaded)}</td>` :
                                `<td>${size}</td>
                                <td>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%">${progressPercent}%</div>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="resumeTorrent('${torrent.hash}')">
                                        <i class="bi bi-play-fill"></i>
                                    </button>
                                </td>`
                            }
                        </tr>
                    `;
                } else {
                    // 完整模式 - 用于全部种子标签
                    return `
                        <tr>
                            <td class="torrent-name" title="${torrent.name}">${torrent.name}</td>
                            <td>
                                <i class="${clientIcon}"></i>
                            </td>
                            <td>${size}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress me-2" style="width: 80px;">
                                        <div class="progress-bar" role="progressbar" style="width: ${progressPercent}%"></div>
                                    </div>
                                    <small>${progressPercent}%</small>
                                </div>
                            </td>
                            <td><span class="badge status-badge ${getStatusClass(torrent.state)}">${getTorrentStateText(torrent.state)}</span></td>
                            <td>${downloadSpeed}</td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-success action-btn" onclick="resumeTorrent('${torrent.hash}')" ${torrent.state.includes('paused') || torrent.state === 'stopped' ? '' : 'disabled'}>
                                        <i class="bi bi-play-fill"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-warning action-btn" onclick="pauseTorrent('${torrent.hash}')" ${torrent.state.includes('paused') || torrent.state === 'stopped' ? 'disabled' : ''}>
                                        <i class="bi bi-pause-fill"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger action-btn" onclick="deleteTorrent('${torrent.hash}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }).join('');
        }
        
        // 格式化字节数
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // 格式化秒数
        function formatSeconds(seconds) {
            if (seconds <= 0) return '0 秒';
            
            const d = Math.floor(seconds / 86400);
            const h = Math.floor((seconds % 86400) / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            
            if (d > 0) return `${d} 天 ${h} 时`;
            if (h > 0) return `${h} 时 ${m} 分`;
            return `${m} 分`;
        }
        
        // 获取种子状态文本
        function getTorrentStateText(state) {
            const stateMap = {
                'downloading': '下载中',
                'stalledDL': '下载停滞',
                'uploading': '上传中',
                'stalledUP': '上传停滞',
                'seeding': '做种中',
                'stopped': '已停止',
                'pausedDL': '已暂停',
                'pausedUP': '已暂停',
                'queuedDL': '队列中',
                'queuedUP': '队列中',
                'checkingDL': '检查中',
                'checkingUP': '检查中',
                'forcedUP': '强制上传',
                'allocating': '分配空间',
                'metaDL': '获取元数据',
                'moving': '移动中'
            };
            return stateMap[state] || state;
        }
        
        // 获取状态类
        function getStatusClass(state) {
            if (['downloading', 'allocating', 'metaDL'].includes(state)) {
                return 'bg-primary';
            } else if (['uploading', 'seeding', 'forcedUP'].includes(state)) {
                return 'bg-success';
            } else if (['stopped'].includes(state)) {
                return 'bg-danger';
            } else if (['stalledDL', 'stalledUP'].includes(state)) {
                return 'bg-warning';
            } else if (['pausedDL', 'pausedUP', 'queuedDL', 'queuedUP'].includes(state)) {
                return 'bg-secondary';
            } else if (['checkingDL', 'checkingUP', 'moving'].includes(state)) {
                return 'bg-info';
            }
            return 'bg-light text-dark';
        }
        
        // 刷新系统状态
        async function refreshSystemStatus() {
            await checkSystemStatus();
            showToast('系统状态已刷新', 'success');
        }
        
        // 刷新客户端
        async function refreshClients() {
            await loadClients();
            showToast('客户端列表已刷新', 'success');
        }
        
        // 刷新种子列表
        async function refreshTorrents() {
            await loadTorrents();
            showToast('种子列表已刷新', 'success');
        }
        
        // 加载更多种子
        function loadMoreTorrents() {
            const clientId = document.getElementById('client-filter').value;
            let filteredTorrents = allTorrents;
            
            // 如果指定了客户端筛选
            if (clientId) {
                filteredTorrents = allTorrents.filter(torrent => torrent.client_id === clientId);
            }
            
            // 加载更多种子
            const currentLength = displayedTorrents.length;
            displayedTorrents = filteredTorrents.slice(0, currentLength + TORRENT_LIMIT);
            renderTorrentList(displayedTorrents, 'all-torrents-list');
            
            // 如果已经加载了所有种子
            if (displayedTorrents.length >= filteredTorrents.length) {
                showToast('已加载所有种子', 'info');
            }
        }
        
        // 恢复种子
        async function resumeTorrent(hash) {
            try {
                const response = await fetch(`${API_BASE}/api/v1/torrents/resume`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hashes: [hash]
                    })
                });
                
                if (response.ok) {
                    showToast('种子已恢复', 'success');
                    await loadTorrents(); // 刷新种子列表
                } else {
                    throw new Error('恢复种子失败');
                }
            } catch (error) {
                console.error('恢复种子失败:', error);
                showToast('恢复种子失败', 'danger');
            }
        }
        
        // 暂停种子
        async function pauseTorrent(hash) {
            try {
                const response = await fetch(`${API_BASE}/api/v1/torrents/pause`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hashes: [hash]
                    })
                });
                
                if (response.ok) {
                    showToast('种子已暂停', 'success');
                    await loadTorrents(); // 刷新种子列表
                } else {
                    throw new Error('暂停种子失败');
                }
            } catch (error) {
                console.error('暂停种子失败:', error);
                showToast('暂停种子失败', 'danger');
            }
        }
        
        // 删除种子
        async function deleteTorrent(hash) {
            if (!confirm('确定要删除这个种子吗？此操作不可撤销。')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/torrents`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hashes: [hash]
                    })
                });
                
                if (response.ok) {
                    showToast('种子已删除', 'success');
                    await loadTorrents(); // 刷新种子列表
                } else {
                    throw new Error('删除种子失败');
                }
            } catch (error) {
                console.error('删除种子失败:', error);
                showToast('删除种子失败', 'danger');
            }
        }
        
        // 显示提示消息
        function showToast(message, type = 'info') {
            const toastEl = document.getElementById('liveToast');
            const toastMessage = document.getElementById('toast-message');
            
            // 设置消息内容
            toastMessage.textContent = message;
            
            // 更新样式
            const toastHeader = toastEl.querySelector('.toast-header');
            toastHeader.className = 'toast-header';
            
            // 根据类型添加图标和样式
            const icon = toastHeader.querySelector('i');
            icon.className = 'bi me-2';
            
            switch (type) {
                case 'success':
                    icon.classList.add('bi-check-circle-fill', 'text-success');
                    break;
                case 'danger':
                    icon.classList.add('bi-exclamation-triangle-fill', 'text-danger');
                    break;
                case 'warning':
                    icon.classList.add('bi-exclamation-circle-fill', 'text-warning');
                    break;
                default:
                    icon.classList.add('bi-info-circle-fill', 'text-primary');
            }
            
            // 显示提示
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
        
        // 客户端筛选事件
        document.getElementById('client-filter')?.addEventListener('change', function() {
            const clientId = this.value;
            let filteredTorrents = allTorrents;
            
            // 如果指定了客户端筛选
            if (clientId) {
                filteredTorrents = allTorrents.filter(torrent => torrent.client_id === clientId);
            }
            
            // 更新显示的种子列表
            displayedTorrents = filteredTorrents.slice(0, TORRENT_LIMIT);
            renderTorrentList(displayedTorrents, 'all-torrents-list');
        });
        
        // 添加种子表单提交
        document.getElementById('add-torrent-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const clientId = document.getElementById('client-select').value;
            const url = document.getElementById('torrent-url').value.trim();
            const savePath = document.getElementById('save-path').value.trim();
            const category = document.getElementById('category').value.trim();
            
            // 验证表单
            if (!clientId) {
                showToast('请选择客户端', 'warning');
                return;
            }
            
            if (!url) {
                showToast('请输入种子URL', 'warning');
                return;
            }
            
            // 准备请求数据
            const requestData = {
                client_id: clientId,
                url: url
            };
            
            if (savePath) {
                requestData.save_path = savePath;
            }
            
            if (category) {
                requestData.category = category;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/torrents`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast('种子添加成功', 'success');
                    // 清空表单
                    this.reset();
                    // 刷新种子列表
                    await loadTorrents();
                    // 切换到种子列表标签
                    const allTab = new bootstrap.Tab(document.getElementById('all-tab'));
                    allTab.show();
                } else {
                    throw new Error(result.error || '添加种子失败');
                }
            } catch (error) {
                console.error('添加种子失败:', error);
                showToast(error.message || '添加种子失败', 'danger');
            }
        });
    </script>
</body>
</html>